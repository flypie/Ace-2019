Zilog Macro Assembler.  Version K2.14    27-Jan-120    21:37:00    Page:    1


c:\users\john bradley\dropbox\ace-2019\newrom\sio.asm

Location Object              Type  Line Source
                             A        1 	INCLUDE "iodefs.inc"
                   000000FC  B        1 KIOBASE	equ	0FCh
                             B        2 
                   00000000  B        3 PIOIOBASE	equ	00B
                   00000001  B        4 CTCIOBASE	equ	01B
                   00000002  B        5 SIOIOBASE	equ	10B
                   00000003  B        6 PIAIOBASE	equ	11B
                   00000003  B        7 KIOIOBASE	equ	11B
                             B        8 
                   00000000  B        9 PIOPORTADATA	equ	00b
                   00000001  B       10 PIOPORTACMD		equ	01b
                   00000000  B       11 PIOPORTBDATA	equ	00b
                   00000001  B       12 PIOPORTBCMD		equ	01b
                             B       13 
                   00000000  B       14 CTCCHANNEL0		equ	00b
                   00000001  B       15 CTCCHANNEL1		equ	01b
                   00000002  B       16 CTCCHANNEL2		equ	10b
                   00000003  B       17 CTCCHANNEL3		equ	11b
                             B       18 
                   00000000  B       19 SIOPORTADATA	equ	00b
                   00000001  B       20 SIOPORTACMD		equ	01b
                   00000000  B       21 SIOPORTBDATA	equ	00b
                   00000001  B       22 SIOPORTBCMD		equ	01b
                             B       23 
                   00000000  B       24 PIAPORTCDATA	equ	00b
                   00000001  B       25 PIAPORTCCMD		equ	01b
                             B       26 
                   00000002  B       27 KIOCOMMANDA		equ	10b
                   00000003  B       28 KIOCOMMANDB		equ	11b
                             B       29 
                             B       30 MAKEPORT	MACRO	Name,Base,Device,Register
                             B       31 Name equ Base|(Device<<8)|(Register<<10)
                             B       32 	endmac 
                             B       33 
                             B       34 
                             B       35 	MAKEPORT PIOADATA,KIOBASE,PIOIOBASE,PIOPORTADATA
                   000000FC  B+      35 Name equ Base|(Device<<8)|(Register<<10)
                             B       36 	MAKEPORT PIOACMD,KIOBASE,PIOIOBASE,PIOPORTACMD
                   000004FC  B+      36 Name equ Base|(Device<<8)|(Register<<10)
                             B       37 	MAKEPORT PIOBDATA,KIOBASE,PIOIOBASE,PIOPORTBDATA
                   000000FC  B+      37 Name equ Base|(Device<<8)|(Register<<10)
                             B       38 	MAKEPORT PIOBCMD,KIOBASE,PIOIOBASE,PIOPORTBCMD
                   000004FC  B+      38 Name equ Base|(Device<<8)|(Register<<10)
                             B       39 
                             B       40 	MAKEPORT CTCCH0,KIOBASE,CTCIOBASE,CTCCHANNEL0
                   000001FC  B+      40 Name equ Base|(Device<<8)|(Register<<10)
                             B       41 	MAKEPORT CTCCH1,KIOBASE,CTCIOBASE,CTCCHANNEL1
                   000005FC  B+      41 Name equ Base|(Device<<8)|(Register<<10)
                             B       42 	MAKEPORT CTCCH2,KIOBASE,CTCIOBASE,CTCCHANNEL2
                   000009FC  B+      42 Name equ Base|(Device<<8)|(Register<<10)
                             B       43 	MAKEPORT CTCCH3,KIOBASE,CTCIOBASE,CTCCHANNEL3
                   00000DFC  B+      43 Name equ Base|(Device<<8)|(Register<<10)
                             B       44 
                             B       45 	MAKEPORT SIOADATA,KIOBASE,SIOIOBASE,SIOPORTADATA
                   000002FC  B+      45 Name equ Base|(Device<<8)|(Register<<10)
                             B       46 	MAKEPORT SIOACMD,KIOBASE,SIOIOBASE,SIOPORTACMD
                   000006FC  B+      46 Name equ Base|(Device<<8)|(Register<<10)
                             B       47 	MAKEPORT SIOBDATA,KIOBASE,SIOIOBASE,SIOPORTBDATA
Zilog Macro Assembler.  Version K2.14    27-Jan-120    21:37:00    Page:    2


iodefs.inc

Location Object              Type  Line Source
                   000002FC  B+      47 Name equ Base|(Device<<8)|(Register<<10)
                             B       48 	MAKEPORT SIOBCMD,KIOBASE,SIOIOBASE,SIOPORTBCMD
                   000006FC  B+      48 Name equ Base|(Device<<8)|(Register<<10)
                             B       49 
                             B       50 	MAKEPORT PIOCDATA,KIOBASE,PIAIOBASE,PIAPORTCDATA
                   000003FC  B+      50 Name equ Base|(Device<<8)|(Register<<10)
                             B       51 	MAKEPORT PIOCCMD,KIOBASE,PIAIOBASE,PIAPORTCCMD
                   000007FC  B+      51 Name equ Base|(Device<<8)|(Register<<10)
                             B       52 
                             B       53 	MAKEPORT KIOCMDA,KIOBASE,KIOIOBASE,KIOCOMMANDA
                   00000BFC  B+      53 Name equ Base|(Device<<8)|(Register<<10)
                             B       54 	MAKEPORT KIOCMDB,KIOBASE,KIOIOBASE,KIOCOMMANDB
                   00000FFC  B+      54 Name equ Base|(Device<<8)|(Register<<10)
                             B       55 
                             B       56 	
                   000000F0  B       57 WDTMT	equ	0F0h
                   000000F1  B       58 WDTCR	equ	0F1h
                             B       59 
                   000000F4  B       60 IPR		equ	0F4h
                             B       61 
                   000000EE  B       62 SCRP	equ	0EEh
                   000000EF  B       63 SCDP	equ	0EFh
                             B       64 
                   00000020  B       65 SERIALTXBUFFLEN	equ	020h	;must be power of 2
                             B       66 
                             B       67 DEFB MACRO P1
                             B       68 	DB P1
                             B       69 	MACEND
                             B       70 
                             B       71 DEFW MACRO P1
                             B       72 	DW P1
                             B       73 	MACEND
                             B       74 
                             B       75 DEFM MACRO P1
                             B       76 	DB P1
                             B       77 	MACEND
                             B       78 
                             B       79 
                             A        2 	.DEFINE DEUCEROM
                             A        3 	.SECTION DEUCEROM
                             A        4 
                             A        5 ;--------------------------
                             A        6 
                             A        7 
                             A        8 	PUBLIC INIT_SIO, SIOASendChar
                             A        9 	PUBLIC SIOAINT_TBE,SIOAINT_ESC,SIOAINT_RCA,SIOAINT_SRC,SIOBINT_TBE,SIOBINT_ESC,SIOBINT_RCA,SIOBINT_SRC
                             A       10 
                             A       11 	EXTERN SIOINTTBL
                             A       12 	EXTERN SIOATXQ, SIOANEXTIN, SIOANEXTOUT,SIOATXBUFF
                             A       13 
00000000                     A       14 INIT_SIO:
00000000 3E 00               A       15 	ld	a,0
00000002 32 00 00            A       16 	ld (SIOANEXTIN),a
00000005 32 00 00            A       17 	ld (SIOANEXTOUT),a
00000008 C9                  A       18 	ret
                             A       19 
                             A       20 ;-------------------------------------------------------------------------------
00000009                     A       21 setSIO:
Zilog Macro Assembler.  Version K2.14    27-Jan-120    21:37:00    Page:    3


c:\users\john bradley\dropbox\ace-2019\newrom\sio.asm

Location Object              Type  Line Source
                             A       22 ;program the SIO
                             A       23 	;set up TX and RX:
                             A       24 	; the followings are settings for channel A
00000009 3E 30               A       25 	ld a,00110000b	; write into WR0: error reset, select WR0
0000000B 01 FC 06            A       26 	ld BC,SIOACMD
0000000E ED 79               A       27 	out (BC),A
00000010 3E 18               A       28 	ld a,00011000b	; write into WR0: channel reset
00000012 ED 79               A       29 	out (BC),A
                             A       30 
00000014 3E 04               A       31 	ld a,00000100b	; write into WR0: select WR4
00000016 ED 79               A       32 	out (BC),A
00000018 3E 44               A       33 	ld a,01000100b	; write into WR4: presc. 16x, 1 stop bit, no parity ; IF Crsta; 1.8432 MHZ this is 115200 baud
0000001A ED 79               A       34 	out (BC),A
                             A       35 
0000001C 3E 05               A       36 	ld a,00000101b	; write into WR0: select WR5
0000001E ED 79               A       37 	out (BC),A
00000020 3E E8               A       38 	ld a,11101000b	; write into WR5: DTR on, TX 8 bits, BREAK off, TX on, RTS off
00000022 ED 79               A       39 	out (BC),A
                             A       40 
                             A       41 	; the following are settings for channel B
00000024 3E 01               A       42 	ld a,00000001b	; write into WR0: select WR1
00000026 01 FC 06            A       43 	ld BC,SIOBCMD
00000029 ED 79               A       44 	out (BC),A
0000002B 3E 04               A       45 	ld a,00000100b	; write into WR0: status affects interrupt vectors
0000002D ED 79               A       46 	out (BC),A
                             A       47 
0000002F 3E 02               A       48 	ld a,00000010b	; write into WR0: select WR2
00000031 ED 79               A       49 	out (BC),A
00000033 3E 00               A       50 	ld a,SIOINTTBL	; write into WR2: set interrupt vector, but bits D3/D2/D1 of this vector
                             A       51 	; will be affected by the channel & condition that raised the interrupt
                             A       52 	; (see datasheet): in our example, 00Ch for Ch.A receiving a char, 0x0E
                             A       53 	; for special conditions
00000035 ED 79               A       54 	out (BC),A
                             A       55 
                             A       56 	; the following are settings for channel A
00000037 3E 01               A       57 	ld a,01h	; write into WR0: select WR1
00000039 01 FC 06            A       58 	ld BC,SIOACMD
0000003C ED 79               A       59 	out (BC),A
0000003E 3E 18               A       60 	ld a,00011000b	; interrupts on every RX char; parity is no special condition;
                             A       61 	; buffer overrun is special condition
00000040 ED 79               A       62 	out (BC),A
                             A       63 
                             A       64 	;enable SIO channel A RX
00000042 3E 03               A       65 	ld a,00000011b	; write into WR0: select WR3
00000044 01 FC 06            A       66 	ld BC,SIOACMD
00000047 ED 79               A       67 	out (BC),A
00000049 3E C1               A       68 	ld a,11000001b	; 8 bits/RX char; auto enable OFF; RX enable
0000004B 01 FC 06            A       69 	ld BC,SIOACMD
0000004E ED 79               A       70 	out (BC),A
00000050 C9                  A       71 	ret
                             A       72 
                             A       73 ;Port A Int handlers
                             A       74 
00000051                     A       75 SIOAINT_TBE:
00000051 F3                  A       76 	di
00000052 CD BC 00            A       77 	call SIOA_TBE
00000055 FB                  A       78 	ei
00000056 ED 4D               A       79 	reti
Zilog Macro Assembler.  Version K2.14    27-Jan-120    21:37:00    Page:    4


c:\users\john bradley\dropbox\ace-2019\newrom\sio.asm

Location Object              Type  Line Source
                             A       80 
00000058                     A       81 SIOAINT_ESC:
00000058 F5                  A       82 	push af	; backup AF
                             A       83 
                             A       84 ;External status
                             A       85 
00000059 F1                  A       86 	pop af
0000005A FB                  A       87 	ei
0000005B ED 4D               A       88 	reti
                             A       89 
0000005D                     A       90 SIOAINT_RCA:
0000005D F5                  A       91 	push af	; backup AF
                             A       92 
0000005E CD B0 00            A       93 	call A_SEND_CHAR
                             A       94 
00000061 F1                  A       95 	pop af
00000062 FB                  A       96 	ei
00000063 ED 4D               A       97 	reti
                             A       98 
00000065                     A       99 SIOAINT_SRC:
00000065 F5                  A      100 	push af	; backup AF
                             A      101 
                             A      102 ;Special Receive Condition
                             A      103 
00000066 F1                  A      104 	pop af
00000067 FB                  A      105 	ei
00000068 ED 4D               A      106 	reti
                             A      107 
                             A      108 ;Port B int handlers
                             A      109 
0000006A                     A      110 SIOBINT_TBE:
0000006A F5                  A      111 	push af	; backup AF
                             A      112 
                             A      113 ;Transmitt buffer empty
                             A      114 
0000006B F1                  A      115 	pop af
0000006C FB                  A      116 	ei
0000006D ED 4D               A      117 	reti
                             A      118 
0000006F                     A      119 SIOBINT_ESC:
0000006F F5                  A      120 	push af	; backup AF
                             A      121 
                             A      122 ;External status
                             A      123 
00000070 F1                  A      124 	pop af
00000071 FB                  A      125 	ei
00000072 ED 4D               A      126 	reti
                             A      127 
00000074                     A      128 SIOBINT_RCA:
00000074 F5                  A      129 	push af	; backup AF
                             A      130 
00000075 01 FC 02            A      131 	ld BC,SIOBDATA
00000078 ED 79               A      132 	out (BC),A	; echo char to transmitter
                             A      133 
0000007A F1                  A      134 	pop af
0000007B FB                  A      135 	ei
0000007C ED 4D               A      136 	reti
                             A      137 
Zilog Macro Assembler.  Version K2.14    27-Jan-120    21:37:00    Page:    5


c:\users\john bradley\dropbox\ace-2019\newrom\sio.asm

Location Object              Type  Line Source
0000007E                     A      138 SIOBINT_SRC:
0000007E F5                  A      139 	push af	; backup AF
                             A      140 
                             A      141 ;Special Receive Condition
                             A      142 
0000007F F1                  A      143 	pop af
00000080 FB                  A      144 	ei
00000081 ED 4D               A      145 	reti
                             A      146 
                             A      147 
                             A      148 	;-------------------------------------------------------------------------------
                             A      149 ; serial management
                             A      150 
00000083                     A      151 A_RTS_OFF:
00000083 3E 05               A      152 	ld a,00000101b	; write into WR0: select WR5
00000085 01 FC 06            A      153 	ld BC,SIOACMD
00000088 ED 79               A      154 	out (BC),A
0000008A 3E E8               A      155 	ld a,11101000b	; 8 bits/TX char; TX enable; RTS disable
0000008C 01 FC 06            A      156 	ld BC,SIOACMD
0000008F ED 79               A      157 	out (BC),A
00000091 C9                  A      158 	ret
                             A      159 
00000092                     A      160 A_RTS_ON:
00000092 3E 05               A      161 	ld a,00000101b	; write into WR0: select WR5
00000094 01 FC 06            A      162 	ld BC,SIOACMD
00000097 ED 79               A      163 	out (BC),A
00000099 3E EA               A      164 	ld a,11101010b	; 8 bits/TX char; TX enable; RTS enable
0000009B 01 FC 06            A      165 	ld BC,SIOACMD
0000009E ED 79               A      166 	out (BC),A
000000A0 C9                  A      167 	ret
                             A      168 
000000A1                     A      169 SIO_A_DI:
                             A      170 	;disable SIO channel A RX
000000A1 3E 03               A      171 	ld a,00000011b	; write into WR0: select WR3
000000A3 01 FC 06            A      172 	ld BC,SIOACMD
000000A6 ED 79               A      173 	out (BC),A
000000A8 3E 0C               A      174 	ld a,00001100b	; write into WR3: RX disable;
000000AA 01 FC 06            A      175 	ld BC,SIOACMD
000000AD ED 79               A      176 	out (BC),A
000000AF C9                  A      177 	ret
                             A      178 
000000B0                     A      179 A_SEND_CHAR:
000000B0 CD 83 00            A      180 	call A_RTS_OFF
                             A      181 
000000B3 01 FC 02            A      182 	ld BC,SIOADATA
000000B6 ED 79               A      183 	out (BC),A	; echo char to transmitter
                             A      184 
000000B8 CD 92 00            A      185 	call A_RTS_ON
000000BB C9                  A      186 	ret
                             A      187 
                             A      188 
                             A      189 	
                             A      190 
                             A      191 
000000BC                     A      192 SIOA_TBE:
000000BC F5                  A      193 	push af	; backup AF
000000BD C5                  A      194 	push bc	; backup AF
000000BE D5                  A      195 	push de	; backup AF
Zilog Macro Assembler.  Version K2.14    27-Jan-120    21:37:00    Page:    6


c:\users\john bradley\dropbox\ace-2019\newrom\sio.asm

Location Object              Type  Line Source
000000BF E5                  A      196 	push hl	; backup AF
000000C0 FD E5               A      197 	push iy	; backup AF
                             A      198 
                             A      199 ;test.c:16: if (NextIn != NextOut)
000000C2 3A 00 00            A      200 	ld	a,(SIOANEXTIN)
000000C5 FD 21 00 00         A      201 	ld	iy,SIOANEXTOUT
000000C9 FD 96 00            A      202 	sub	a,(iy)
000000CC 28 1D               A      203 	jr	Z,SIOAINT_TBE_EXIT
                             A      204 ;test.c:18: UART1_SendData8(UBuffer[NextOut++]);
000000CE 01 00 00            A      205 	ld	bc, SIOATXBUFF
000000D1 FD 5E 00            A      206 	ld	e, (iy)
000000D4 FD 34 00            A      207 	inc	(iy)
000000D7 6B                  A      208 	ld	l, e
000000D8 26 00               A      209 	ld	h, 00h
000000DA 09                  A      210 	add	hl, bc
000000DB 7E                  A      211 	ld	a, (hl)
                             A      212 
000000DC CD B0 00            A      213 	call A_SEND_CHAR
                             A      214 
                             A      215 ;test.c:19: NextOut &= 0x1F;
000000DF FD 21 00 00         A      216 	ld	iy, SIOANEXTOUT
000000E3 FD 7E 00            A      217 	ld	a, (iy)
000000E6 E6 1F               A      218 	and	a, 01fh
000000E8 FD 77 00            A      219 	ld	(iy), a
                             A      220 
000000EB                     A      221 SIOAINT_TBE_EXIT:
                             A      222 
000000EB FD E1               A      223 	pop iy	
000000ED E1                  A      224 	pop hl	
000000EE D1                  A      225 	pop de	
000000EF C1                  A      226 	pop bc	
000000F0 F1                  A      227 	pop af
000000F1 C9                  A      228 	ret	
                             A      229 ;	---------------------------------
                             A      230 ; Function UARTSendChar
                             A      231 ; ---------------------------------
000000F2                     A      232 SIOASendChar: ; Char to send is in A
                             A      233 ;test.c:32: UBuffer[NextIn++] = Byte;
000000F2 F5                  A      234 	push af;
000000F3 3A 00 00            A      235 	ld	a,(SIOANEXTIN)
000000F6 FD 21 00 00         A      236 	ld	iy, SIOANEXTOUT
000000FA FD 96 00            A      237 	sub	a,(iy+0)
000000FD 28 05               A      238 	jr	Z,ISEMPTY
                             A      239 
000000FF 16 00               A      240 	ld d,0
00000101 C3 06 01            A      241 	jp FLAGSET
00000104                     A      242 ISEMPTY:
00000104 16 01               A      243 	ld d,1
                             A      244 
00000106                     A      245 FLAGSET:
00000106 FD 21 00 00         A      246 	ld	iy, SIOANEXTIN
0000010A FD 4E 00            A      247 	ld	c, (iy)
0000010D FD 34 00            A      248 	inc	(iy)
00000110 21 00 00            A      249 	ld	hl, SIOATXBUFF
00000113 06 00               A      250 	ld	b, 00h
00000115 09                  A      251 	add	hl, bc
                             A      252 
00000116 F1                  A      253 	pop af
Zilog Macro Assembler.  Version K2.14    27-Jan-120    21:37:00    Page:    7


c:\users\john bradley\dropbox\ace-2019\newrom\sio.asm

Location Object              Type  Line Source
00000117 77                  A      254 	ld	(hl), a
                             A      255 ;test.c:33: NextIn &= 0x01F;
00000118 FD 21 00 00         A      256 	ld	iy, SIOANEXTIN
0000011C FD 7E 00            A      257 	ld	a, (iy)
0000011F E6 1F               A      258 	and	a, SERIALTXBUFFLEN-1
00000121 FD 77 00            A      259 	ld	(iy), a
                             A      260 
00000124 7A                  A      261 	ld	a,d
00000125 20 03               A      262 	jr	NZ,EXITTHIS
                             A      263 
00000127 CD 51 00            A      264 	call SIOAINT_TBE
                             A      265 
0000012A                     A      266 EXITTHIS:
0000012A C9                  A      267 	ret
                             A      268 
                             A      269 	
Zilog Macro Assembler.  Version K2.14    27-Jan-120    21:37:00    Page:    8


c:\users\john bradley\dropbox\ace-2019\newrom\sio.asm


    0 Warnings
    0 Errors
